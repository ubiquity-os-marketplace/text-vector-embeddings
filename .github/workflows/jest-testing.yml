name: Run Bun testing suite
on:
  workflow_dispatch:
  pull_request:

env:
  NODE_ENV: "test"

jobs:
  testing:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install toolchain
        run: bun install --frozen-lockfile

      - name: Bun Test With Coverage
        run: bun test --coverage --reporter=junit --reporter-outfile=./junit.xml

      - name: Generate Markdown Dashboard from JUnit XML
        run: |
          bun add fast-xml-parser@4.2.5
          cat <<'EOF' > junit-to-md.ts
          import { readFileSync, writeFileSync } from "fs";
          import { XMLParser } from "fast-xml-parser";

          function formatDuration(sec: number) {
            return sec > 1 ? `${sec.toFixed(3)} s` : `${(sec * 1000).toFixed(0)} ms`;
          }

          const xml = readFileSync("junit.xml", "utf8");
          const parser = new XMLParser({ ignoreAttributes: false, attributeNamePrefix: "" });
          const data = parser.parse(xml);

          const suites = data.testsuites;
          const suiteList = Array.isArray(suites.testsuite) ? suites.testsuite : [suites.testsuite];
          const totalTests = Number(suites.tests);
          const totalFailures = Number(suites.failures);
          const totalSkipped = Number(suites.skipped);
          const totalTime = Number(suites.time);

          let md = `Test Dashboard
          ðŸ•™ Start time\tâŒ› Duration
          ${new Date().toLocaleString()}\t${formatDuration(totalTime)}

          âœ… Passed\tâŒ Failed\tðŸš§ Todo\tâšª Total
          Test Suites\t${suiteList.length}\t${totalFailures}\t-\t${suiteList.length}
          Tests\t${totalTests - totalFailures - totalSkipped}\t${totalFailures}\t${totalSkipped}\t${totalTests}
          `;

          for (const suite of suiteList) {
            const file = suite.file || suite.name;
            const cases = suite.testsuite?.testcase || suite.testcase || [];
            const testcases = Array.isArray(cases) ? cases : [cases];
            const passed = testcases.filter(tc => !tc.failure && !tc.skipped).length;
            const failed = testcases.filter(tc => !!tc.failure).length;
            const skipped = testcases.filter(tc => !!tc.skipped).length;
            const suiteTime = Number(suite.time || 0);

            md += `\n[${file}](./${file})\n${passed} passed, ${failed} failed, ${skipped} todo, done in ${formatDuration(suiteTime)}\n`;

            for (const tc of testcases) {
              let status = "âœ…";
              if (tc.failure) status = "âŒ";
              else if (tc.skipped) status = "ðŸš§";
              md += `${status} ${tc.name}\n`;
            }
          }

          writeFileSync("test-dashboard.md", md);
          EOF
          bun run junit-to-md.ts

      - name: Add Bun Report to Summary
        if: always()
        run: echo "$(cat test-dashboard.md)" >> $GITHUB_STEP_SUMMARY
