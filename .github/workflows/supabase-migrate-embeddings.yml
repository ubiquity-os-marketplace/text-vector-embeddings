name: Supabase Migrate Embeddings

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Number of rows per batch (default 100)."
        required: false
        default: "100"
      dry_run:
        description: "Set to true to skip writes."
        required: false
        default: "false"

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then echo "Missing SUPABASE_URL"; exit 1; fi
          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then echo "Missing SUPABASE_KEY"; exit 1; fi
          if [ -z "${{ secrets.SUPABASE_TARGET_URL }}" ]; then echo "Missing SUPABASE_TARGET_URL"; exit 1; fi
          if [ -z "${{ secrets.SUPABASE_TARGET_KEY }}" ]; then echo "Missing SUPABASE_TARGET_KEY"; exit 1; fi
          if [ "${{ inputs.dry_run }}" != "true" ] && [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then echo "Missing SUPABASE_ACCESS_TOKEN"; exit 1; fi
          if [ "${{ inputs.dry_run }}" != "true" ] && [ -z "${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}" ]; then echo "Missing SUPABASE_TARGET_DB_PASSWORD"; exit 1; fi

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Resolve Supavisor host
        if: inputs.dry_run != 'true'
        run: |
          set -euo pipefail
          ref="${SUPABASE_TARGET_URL#https://}"
          ref="${ref%.supabase.co}"
          project_json=$(supabase projects list --output json)
          project=$(echo "$project_json" | jq -r --arg ref "$ref" '.[] | select(.ref == $ref)')
          if [ -z "$project" ] || [ "$project" = "null" ]; then
            echo "Unable to locate project ref $ref in Supabase projects list."
            exit 1
          fi
          region=$(echo "$project" | jq -r '.region // empty')
          cloud=$(echo "$project" | jq -r '.cloud_provider // .cloud // "aws"')
          cloud=$(echo "$cloud" | tr '[:upper:]' '[:lower:]')
          if [ -z "$region" ]; then
            echo "Supabase project region not found."
            exit 1
          fi
          pooler_host="${cloud}-0-${region}.pooler.supabase.com"
          echo "SUPABASE_POOLER_HOST=$pooler_host" >> "$GITHUB_ENV"
          echo "SUPABASE_PROJECT_REF=$ref" >> "$GITHUB_ENV"
        env:
          SUPABASE_TARGET_URL: ${{ secrets.SUPABASE_TARGET_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}

      - name: Install Postgres client
        if: inputs.dry_run != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply schema bootstrap
        if: inputs.dry_run != 'true'
        run: |
          set -euo pipefail
          PGPASSWORD="$SUPABASE_TARGET_DB_PASSWORD" \
            psql "postgresql://postgres.${SUPABASE_PROJECT_REF}@${SUPABASE_POOLER_HOST}:5432/postgres?sslmode=require" \
              -v ON_ERROR_STOP=1 \
              -f scripts/bootstrap-schema.sql
        env:
          SUPABASE_TARGET_DB_PASSWORD: ${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}

      - name: Run migration
        run: bun run scripts/migrate-supabase.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_TARGET_URL: ${{ secrets.SUPABASE_TARGET_URL }}
          SUPABASE_TARGET_KEY: ${{ secrets.SUPABASE_TARGET_KEY }}
          BATCH_SIZE: ${{ inputs.batch_size }}
          DRY_RUN: ${{ inputs.dry_run }}
