name: Supabase Migrate Embeddings

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Number of rows per batch (default 100)."
        required: false
        default: "100"
      dry_run:
        description: "Set to true to skip writes."
        required: false
        default: "false"

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then echo "Missing SUPABASE_URL"; exit 1; fi
          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then echo "Missing SUPABASE_KEY"; exit 1; fi
          if [ -z "${{ secrets.SUPABASE_TARGET_URL }}" ]; then echo "Missing SUPABASE_TARGET_URL"; exit 1; fi
          if [ -z "${{ secrets.SUPABASE_TARGET_KEY }}" ]; then echo "Missing SUPABASE_TARGET_KEY"; exit 1; fi
          if [ "${{ inputs.dry_run }}" != "true" ] && [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then echo "Missing SUPABASE_ACCESS_TOKEN"; exit 1; fi
          if [ "${{ inputs.dry_run }}" != "true" ] && [ -z "${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}" ]; then echo "Missing SUPABASE_TARGET_DB_PASSWORD"; exit 1; fi

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        if: inputs.dry_run != 'true'
        run: |
          set -euo pipefail
          ref="${SUPABASE_TARGET_URL#https://}"
          ref="${ref%.supabase.co}"
          supabase link --project-ref "$ref"
        env:
          SUPABASE_TARGET_URL: ${{ secrets.SUPABASE_TARGET_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}

      - name: Sync remote migration history
        if: inputs.dry_run != 'true'
        run: supabase migration fetch
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}

      - name: Apply schema migrations
        if: inputs.dry_run != 'true'
        run: printf 'y\n' | supabase db push --include-all
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_TARGET_DB_PASSWORD }}

      - name: Run migration
        run: bun run scripts/migrate-supabase.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_TARGET_URL: ${{ secrets.SUPABASE_TARGET_URL }}
          SUPABASE_TARGET_KEY: ${{ secrets.SUPABASE_TARGET_KEY }}
          BATCH_SIZE: ${{ inputs.batch_size }}
          DRY_RUN: ${{ inputs.dry_run }}
